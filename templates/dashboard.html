<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - MFA System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1>üîê Dashboard</h1>
            </div>
            <div class="nav-links">
                <a href="/profile">Profile</a>
                <a href="#" onclick="logout()">Logout</a>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="dashboard-container">
            <h1 id="welcomeText">Welcome!</h1>
            
            <div id="alertBox" class="alert-box"></div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <h2>üìä Statistics</h2>
                    <div class="stats-box">
                        <p><span>Total Auth Attempts:</span> <strong id="totalAttempts">0</strong></p>
                        <p><span>Successful:</span> <strong id="successfulAttempts">0</strong></p>
                        <p><span>Success Rate:</span> <strong id="successRate">0%</strong></p>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h2>üîê MFA Status</h2>
                    <div class="stats-box">
                        <p><span>Keystroke:</span> <strong id="keystrokeStatus">‚úó Disabled</strong></p>
                        <p><span>Face Recognition:</span> <strong id="faceStatus">‚úó Disabled</strong></p>
                        <p><span>Overall MFA:</span> <strong id="mfaStatus">‚úó Disabled</strong></p>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h2>‚å®Ô∏è Keystroke</h2>
                    <p id="keystrokeInfo">Not enrolled</p>
                    <button onclick="window.location.href='/keystroke_enroll'" class="btn btn-secondary">Enroll</button>
                </div>

                <div class="dashboard-card">
                    <h2>üë§ Face Recognition</h2>
                    <p id="faceInfo">Not enrolled</p>
                    <button onclick="window.location.href='/face_enroll'" class="btn btn-secondary">Enroll</button>
                </div>
            </div>

            <div class="dashboard-card" style="margin-top: 2rem;">
                <h2>üìú Recent Authentication Attempts</h2>
                <table id="authHistoryTable" class="table">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Method</th>
                            <th>Result</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody id="authHistoryBody">
                        <tr><td colspan="4">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        async function loadDashboard() {
            try {
                const token = localStorage.getItem('access_token') || localStorage.getItem('temp_token');
                
                if (!token) {
                    window.location.href = '/login';
                    return;
                }

                // Load user data
                const userResponse = await fetch('/api/user/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (userResponse.ok) {
                    const user = await userResponse.json();
                    document.getElementById('welcomeText').textContent = `Welcome, ${user.username}!`;
                    
                    // Update Keystroke status
                    const keystrokeStatusEl = document.getElementById('keystrokeStatus');
                    keystrokeStatusEl.textContent = user.keystroke_enabled ? '‚úì Enabled' : '‚úó Disabled';
                    keystrokeStatusEl.style.color = user.keystroke_enabled ? 'green' : 'red';
                    
                    // Update Face status
                    const faceStatusEl = document.getElementById('faceStatus');
                    faceStatusEl.textContent = user.face_enabled ? '‚úì Enabled' : '‚úó Disabled';
                    faceStatusEl.style.color = user.face_enabled ? 'green' : 'red';
                    
                    // Update MFA status
                    const mfaStatusEl = document.getElementById('mfaStatus');
                    mfaStatusEl.textContent = user.mfa_enabled ? '‚úì Enabled' : '‚úó Disabled';
                    mfaStatusEl.style.color = user.mfa_enabled ? 'green' : 'red';
                    
                    // Update sample counts
                    document.getElementById('keystrokeInfo').textContent = `Samples: ${user.keystroke_samples}/5`;
                    document.getElementById('faceInfo').textContent = `Samples: ${user.face_samples}/3`;
                } else {
                    console.error('Failed to load user profile');
                    showAlert('Failed to load user profile', 'error');
                }

                // Load statistics
                const statsResponse = await fetch('/api/user/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('totalAttempts').textContent = stats.total_attempts;
                    document.getElementById('successfulAttempts').textContent = stats.successful_attempts;
                    document.getElementById('successRate').textContent = stats.success_rate.toFixed(1) + '%';
                    
                    // Load auth history
                    if (stats.recent_attempts && stats.recent_attempts.length > 0) {
                        const tbody = document.getElementById('authHistoryBody');
                        tbody.innerHTML = '';
                        
                        stats.recent_attempts.forEach(attempt => {
                            // Get the appropriate score
                            let score = 'N/A';
                            if (attempt.combined_score) {
                                score = attempt.combined_score.toFixed(3);
                            } else if (attempt.keystroke_score) {
                                score = attempt.keystroke_score.toFixed(3);
                            } else if (attempt.face_score) {
                                score = attempt.face_score.toFixed(3);
                            }
                            
                            // Get result status
                            const resultStatus = attempt.success ? '‚úì Success' : '‚úó Failed';
                            const resultColor = attempt.success ? 'green' : 'red';
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${new Date(attempt.timestamp).toLocaleString()}</td>
                                <td>${attempt.mfa_method}</td>
                                <td style="color: ${resultColor}; font-weight: bold;">${resultStatus}</td>
                                <td>${score}</td>
                            `;
                            tbody.appendChild(row);
                        });
                    } else {
                        const tbody = document.getElementById('authHistoryBody');
                        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">No authentication attempts yet</td></tr>';
                    }
                } else {
                    console.error('Failed to load statistics');
                    showAlert('Failed to load statistics', 'error');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('Error loading dashboard: ' + error.message, 'error');
            }
        }

        function showAlert(message, type = 'error') {
            const alertBox = document.getElementById('alertBox');
            if (alertBox) {
                alertBox.className = `alert-box alert-${type}`;
                alertBox.textContent = message;
                alertBox.style.display = 'block';
                
                // Auto-hide after 5 seconds
                setTimeout(() => {
                    alertBox.style.display = 'none';
                }, 5000);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear();
                window.location.href = '/login';
            }
        }

        // Load dashboard on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
        });

        // Refresh dashboard every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>